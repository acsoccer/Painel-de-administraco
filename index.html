<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AC Soccer</title>
  <link rel="icon" href="Imagens/SOCCER.png" type="image/x-icon">
  <link rel="icon" href="Imagens/SOCCER.png" sizes="16x16" />
  <link rel="icon" href="Imagens/SOCCER.png" sizes="32x32" type="image/png" />
  <link rel="icon" href="Imagens/SOCCER.png" sizes="48x48" type="image/png" />
  <link rel="apple-touch-icon" href="Imagens/SOCCER.png">
<style>
  :root{
    --bg:#0e1117; --panel:#161b22; --muted:#8b949e; --acc:#2f81f7; --ok:#23a559; --warn:#f39c12; --bad:#e74c3c; --text:#e6edf3; --soft:#21262d;
    --br:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  a{color:var(--acc)}
  .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px}
  .card{background:var(--panel);border:1px solid #30363d;border-radius:var(--br);padding:24px;max-width:520px;width:100%}
  h1,h2,h3{margin:0 0 12px}
  input,select,button,textarea{
    width:100%;padding:12px 14px;background:var(--soft);border:1px solid #30363d;color:var(--text);
    border-radius:10px;outline:none;font:inherit
  }
  input:focus,select:focus,textarea:focus{border-color:var(--acc);box-shadow:0 0 0 3px #2f81f733}
  label{display:block;margin:10px 0 6px;color:#c9d1d9}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .row-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{cursor:pointer;border:none}
  .btn.acc{background:var(--acc)}
  .btn.ok{background:var(--ok)}
  .btn.bad{background:var(--bad)}
  .btn.warn{background:var(--warn)}
  .btn.soft{background:var(--soft)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .muted{color:var(--muted);font-size:13px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}
  .tab{padding:10px 14px;border-radius:999px;background:var(--soft);cursor:pointer;border:1px solid #30363d}
  .tab.active{background:var(--acc);border-color:transparent}
  .panel{display:none}
  .panel.active{display:block}
  table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid #30363d;border-radius:12px;overflow:hidden}
  thead th{position:sticky;top:0;background:#0b1220;border-bottom:1px solid #30363d;text-align:left;padding:10px;font-weight:600}
  tbody td{padding:10px;border-bottom:1px solid #30363d}
  tbody tr:hover{background:#1e232b}
  .table-wrap{overflow:auto;border-radius:12px;border:1px solid #30363d}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:var(--soft);border:1px solid #30363d}
  .right{display:flex;justify-content:flex-end}
  .grid{display:grid;gap:12px}
  .chip{padding:6px 10px;border-radius:999px;background:#1b1f24;border:1px solid #30363d;font-size:12px}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:10px 0}
  .kpi .box{background:var(--panel);padding:14px;border:1px solid #30363d;border-radius:12px}
  .nowrap{white-space:nowrap}
  .hide{display:none}
  .danger{color:#ffb4b4}
  .success{color:#b7ffc9}
  .center{text-align:center}
  .small{font-size:12px}
  .sticky-actions{position:sticky;bottom:0;background:linear-gradient(transparent, var(--bg) 10%, var(--bg));padding-top:8px}
  @media (max-width:820px){
    .row,.row-3,.row-4{grid-template-columns:1fr}
    table{font-size:14px}
    thead th,tbody td{padding:8px}
  }
  .iac{height: 50px;}
  .soccer {position: relative; height: 80px; margin: 0px 0px -15px -3%;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginView" class="wrap">
  <div class="card">
    <img class="iac" src="Imagens/logo bc sem fundo.png" alt="iac">
    <img class="soccer" src="Imagens/ACSoccer.png" alt="Soccer">
    <h1>Login Administrativo</h1>
    <p class="muted">Insira a chave de acesso para entrar no painel.</p>
    <label for="accessKey">Chave de acesso</label>
    <input id="accessKey" type="password" inputmode="numeric" placeholder="******" />
    <div class="actions" style="margin-top:12px">
      <button class="btn acc" onclick="doLogin()">Entrar</button>
      <button class="btn soft" onclick="document.getElementById('accessKey').value=''">Limpar</button>
    </div>
    <p id="loginError" class="danger small"></p>
    <p class="muted small">Dica: chave <code>Padrão</code>.</p>
  </div>
</div>

<!-- APP -->
<div id="appView" class="wrap" style="display:none;align-items:flex-start">
  <div style="width:100%;max-width:1200px">
    <div class="row" style="align-items:center">
      <h2 style="margin-bottom:0">Painel Administrativo</h2>
      <div class="right actions">
        <span class="pill">Usuário: <strong>Administrador</strong></span>
        <button class="btn soft" onclick="logout()">Sair</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="chegada">Lista de Chegada</button>
      <button class="tab" data-tab="cadastro">Cadastro de Atletas</button>
      <button class="tab" data-tab="caixa">Controle de Caixa</button>
      <button class="tab" data-tab="campeonato">Campeonato</button>
    </div>

    <!-- LISTA DE CHEGADA -->
    <section id="panel-chegada" class="panel active">
      <div class="grid">
        <div class="row">
          <div>
            <label>Adicionar atleta (1 por linha)</label>
            <input id="novoNomeChegada" placeholder="Ex.: João da Silva" onkeydown="if(event.key==='Enter'){addToChegada()}" />
            <div class="actions" style="margin-top:8px">
              <button class="btn ok" onclick="addToChegada()">Adicionar</button>
              <button class="btn warn" onclick="gerarPrimeirasEquipes()">Gerar 2 primeiras equipes (16)</button>
              <button class="btn soft" onclick="gerarDemaisEquipes()">Embaralhar restantes (8/8)</button>
              <button class="btn bad" onclick="limparChegada()">Limpar lista</button>
            </div>
            <p class="muted small">Dica: você pode colar vários nomes com quebras de linha.</p>
          </div>
          <div>
            <div class="kpi">
              <div class="box"><div class="muted small">Total na fila</div><div id="kpiFila" style="font-size:22px;font-weight:700">0</div></div>
              <div class="box"><div class="muted small">Equipes criadas</div><div id="kpiEquipes" style="font-size:22px;font-weight:700">0</div></div>
              <div class="box"><div class="muted small">Restantes</div><div id="kpiRest" style="font-size:22px;font-weight:700">0</div></div>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead><tr><th style="width:60px">#</th><th>Nome</th><th class="right">Ações</th></tr></thead>
            <tbody id="tbodyChegada"></tbody>
          </table>
        </div>

        <div id="equipesWrap" class="grid"></div>
      </div>
    </section>

    <!-- CADASTRO -->
    <section id="panel-cadastro" class="panel">
      <div class="grid">
        <h3>Cadastro de Atletas</h3>
        <form id="formAtleta" onsubmit="salvarAtleta(event)" class="grid">
          <div class="row">
            <div>
              <label>Nome completo (mín. 10 letras)</label>
              <input id="cadNome" required />
            </div>
            <div>
              <label>Data de nascimento</label>
              <input id="cadNasc" type="date" required onchange="atualizaIdadeResp()" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Responsável (obrigatório &lt; 16 anos)</label>
              <input id="cadResp" />
            </div>
            <div>
              <label>CPF</label>
              <input id="cadCPF" inputmode="numeric" placeholder="Somente números" required />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Telefone (XXXXXXXXXXX)</label>
              <input id="cadFone" inputmode="numeric" placeholder="11 dígitos" required />
            </div>
            <div>
              <label>CEP</label>
              <input id="cadCEP" inputmode="numeric" placeholder="Somente números" onchange="buscaCEP()" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Endereço</label>
              <input id="cadEndereco" />
            </div>
            <div>
              <label>Complemento</label>
              <input id="cadCompl" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Número</label>
              <input id="cadNum" />
            </div>
            <div class="actions sticky-actions">
              <button class="btn ok" type="submit">Salvar</button>
              <button class="btn soft" type="button" onclick="formReset()">Limpar</button>
            </div>
          </div>
          <input type="hidden" id="cadIdEditing" />
        </form>

        <div class="row" style="align-items:end">
          <div>
            <label>Buscar por ID / Nome / Idade / Data Nasc. / CPF</label>
            <input id="buscaAtleta" placeholder="Ex.: 123 / Maria / 15 / 2008-05-01 / 12345678909" oninput="renderAtletas()" />
          </div>
          <div class="right actions">
            <button class="btn warn" onclick="exportarPDF('listaAtletasArea','Atletas')">Exportar PDF</button>
          </div>
        </div>

        <div class="table-wrap" id="listaAtletasArea">
          <table>
            <thead>
              <tr>
                <th class="nowrap">ID</th><th>Nome</th><th class="nowrap">Idade</th><th class="nowrap">Data Nasc.</th>
                <th class="nowrap">CPF</th><th class="nowrap">Telefone</th><th>Endereço</th><th class="nowrap">Pago (R$)</th><th class="right">Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyAtletas"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CAIXA -->
    <section id="panel-caixa" class="panel">
      <div class="grid">
        <h3>Controle de Caixa</h3>
        <div class="kpi">
          <div class="box"><div class="muted small">Total do Caixa</div><div id="kpiCaixa" style="font-size:28px;font-weight:800">R$ 0,00</div></div>
          <div class="box"><div class="muted small">Entradas</div><div id="kpiEntradas" style="font-size:22px;font-weight:700">R$ 0,00</div></div>
          <div class="box"><div class="muted small">Saídas</div><div id="kpiSaidas" style="font-size:22px;font-weight:700">R$ 0,00</div></div>
        </div>

        <h4>Nova Movimentação</h4>
        <form class="grid" onsubmit="salvarMov(event)">
          <div class="row">
            <div>
              <label>Tipo</label>
              <select id="movTipo">
                <option value="entrada">Entrada</option>
                <option value="saida">Saída</option>
              </select>
            </div>
            <div>
              <label>Valor (R$)</label>
              <input id="movValor" type="number" step="0.01" min="0" required />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Vincular ao Atleta (opcional)</label>
              <select id="movAtleta"></select>
            </div>
            <div>
              <label>Descrição</label>
              <input id="movDesc" placeholder="Ex.: Mensalidade, compra de bolas..." />
            </div>
          </div>
          <div class="actions">
            <button class="btn ok" type="submit">Adicionar</button>
            <button class="btn soft" type="button" onclick="limparMovForm()">Limpar</button>
            <button class="btn warn" type="button" onclick="exportarPDF('listaMovArea','Movimentos')">Exportar PDF</button>
          </div>
        </form>

        <div class="table-wrap" id="listaMovArea">
          <table>
            <thead>
              <tr><th>Data/Hora</th><th>Tipo</th><th>Valor (R$)</th><th>Descrição</th><th>Atleta</th><th class="right">Ações</th></tr>
            </thead>
            <tbody id="tbodyMov"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CAMPEONATO -->
    <section id="panel-campeonato" class="panel">
      <div class="grid">
        <h3>Campeonato</h3>
        <form class="grid" onsubmit="addCampeonatoJogador(event)">
          <div class="row">
            <div>
              <label>Nome do atleta</label>
              <input id="campNome" required />
            </div>
            <div>
              <label>Data de nascimento</label>
              <input id="campNasc" type="date" required onchange="document.getElementById('campIdade').value=calcIdade(this.value)" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Idade</label>
              <input id="campIdade" readonly />
            </div>
            <div class="actions">
              <button class="btn ok" type="submit">Adicionar ao campeonato</button>
            </div>
          </div>
        </form>

        <div class="row" style="align-items:end">
          <div>
            <label>Ordenar por</label>
            <select id="campSort" onchange="renderCamp()">
              <option value="pontos">Pontos</option>
              <option value="jogos">Jogos</option>
              <option value="vitorias">Vitórias</option>
              <option value="empates">Empates</option>
              <option value="derrotas">Derrotas</option>
              <option value="gols">Gols</option>
              <option value="nome">Nome</option>
            </select>
          </div>
          <div class="right">
            <span class="chip">Pontos = 3×V + 1×E</span>
            <span class="chip">Jogos = V + E + D</span>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Pos.</th><th>Nome</th><th class="nowrap">Pontos</th><th>Jogos</th>
                <th contenteditable="false">Vitórias</th><th>Empates</th><th>Derrotas</th><th>Gols</th><th class="right">Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyCamp"></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>
</div>

<script>
/* ============================================================
   "Banco de dados" embutido (localStorage) e utilitários
   ============================================================ */
const DB_KEYS = {
  chegada: 'db_chegada',
  equipes: 'db_equipes',
  atletas: 'db_atletas',
  movimentos: 'db_movimentos',
  campeonato: 'db_campeonato'
};
const ADMIN_KEY = '074708';

function dbGet(key, fallback){
  const raw = localStorage.getItem(key);
  if(!raw) return fallback;
  try{ return JSON.parse(raw); }catch{ return fallback; }
}
function dbSet(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

function money(n){ return (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function randId3(){ return Math.floor(100 + Math.random()*900); }
function slug(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
function shuffle(arr){ const a = [...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function calcIdade(dateStr){
  if(!dateStr) return '';
  const d = new Date(dateStr);
  if(Number.isNaN(d.getTime())) return '';
  const today = new Date();
  let age = today.getFullYear()-d.getFullYear();
  const m = today.getMonth()-d.getMonth();
  if(m<0 || (m===0 && today.getDate()<d.getDate())) age--;
  return age;
}
function onlyDigits(s){ return (s||'').replace(/\D+/g,''); }
function validaCPF(cpf){
  cpf = onlyDigits(cpf);
  if(!cpf || cpf.length!==11) return false;
  if(/^(\d)\1+$/.test(cpf)) return false;
  let soma=0; for(let i=0;i<9;i++) soma+=parseInt(cpf.charAt(i))*(10-i);
  let d1 = 11-(soma%11); d1=(d1>9)?0:d1;
  if(d1!==parseInt(cpf.charAt(9))) return false;
  soma=0; for(let i=0;i<10;i++) soma+=parseInt(cpf.charAt(i))*(11-i);
  let d2 = 11-(soma%11); d2=(d2>9)?0:d2;
  return d2===parseInt(cpf.charAt(10));
}
function exportarPDF(areaId, titulo='Export'){
  // Abre uma janela só com a tabela e chama print (o usuário escolhe "Salvar como PDF")
  const area = document.getElementById(areaId);
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>${titulo}</title>
  <style>
    body{font-family:Arial,sans-serif;padding:16px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #999;padding:8px;text-align:left;font-size:12px}
    thead th{background:#efefef;position:sticky;top:0}
    h2{margin:0 0 12px}
  </style></head><body>
  <h2>${titulo}</h2>${area.outerHTML}</body></html>`);
  w.document.close(); w.focus(); w.print();
}

/* ============================================================
   Login
   ============================================================ */
function doLogin(){
  const v = document.getElementById('accessKey').value.trim();
  if(v===ADMIN_KEY){
    document.getElementById('loginView').style.display='none';
    document.getElementById('appView').style.display='flex';
    renderAll();
  } else {
    document.getElementById('loginError').textContent='Chave incorreta.';
  }
}
function logout(){
  document.getElementById('appView').style.display='none';
  document.getElementById('loginView').style.display='flex';
  document.getElementById('accessKey').value='';
  document.getElementById('loginError').textContent='';
}

/* ============================================================
   Abas
   ============================================================ */
document.querySelectorAll('.tab').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    b.classList.add('active');
    document.getElementById('panel-'+b.dataset.tab).classList.add('active');
    if(b.dataset.tab==='caixa') fillAtletasSelect();
  });
});

/* ============================================================
   Lista de Chegada / Equipes
   ============================================================ */
function addToChegada(){
  const input = document.getElementById('novoNomeChegada');
  let val = input.value.trim();
  if(!val){ return; }
  const list = dbGet(DB_KEYS.chegada, []);
  // Permitir colagem de vários nomes (quebras de linha)
  val.split(/\n+/).map(s=>s.trim()).filter(Boolean).forEach(n=>list.push(n));
  dbSet(DB_KEYS.chegada, list);
  input.value='';
  renderChegada();
}
function removerChegada(idx){
  const list = dbGet(DB_KEYS.chegada, []);
  list.splice(idx,1);
  dbSet(DB_KEYS.chegada, list);
  renderChegada();
}
function limparChegada(){
  if(!confirm('Deseja realmente limpar toda a lista de chegada?')) return;
  dbSet(DB_KEYS.chegada, []);
  dbSet(DB_KEYS.equipes, []);
  renderChegada(); renderEquipes();
}

function gerarPrimeirasEquipes(){
  const list = dbGet(DB_KEYS.chegada, []);
  if(list.length<16){ alert('É necessário ter ao menos 16 nomes na fila.'); return; }
  const primeiros16 = list.slice(0,16);
  const resto = list.slice(16);
  const embaralhados = shuffle(primeiros16);
  const t1 = embaralhados.slice(0,8);
  const t2 = embaralhados.slice(8,16);
  const equipes = dbGet(DB_KEYS.equipes, []);
  equipes.unshift({ titulo:'Equipes Iniciais', tabelas: [
    {nome:'Equipe A', linhas: tabelaDeEstat(t1, 10)}, // 10 linhas
    {nome:'Equipe B', linhas: tabelaDeEstat(t2, 10)}
  ]});
  dbSet(DB_KEYS.equipes, equipes);
  dbSet(DB_KEYS.chegada, resto);
  renderChegada(); renderEquipes();
}
function gerarDemaisEquipes(){
  const list = dbGet(DB_KEYS.chegada, []);
  if(list.length<1){ alert('Não há nomes restantes.'); return; }
  const embar = shuffle(list);
  const equipesNovas = [];
  for(let i=0;i<embar.length;i+=8){
    const grupo = embar.slice(i,i+8);
    equipesNovas.push({nome:`Grupo ${i/8+1}`, linhas: tabelaDeEstat(grupo, 9)}); // 9 linhas
  }
  const equipes = dbGet(DB_KEYS.equipes, []);
  equipes.push({ titulo:'Grupos Restantes', tabelas: equipesNovas });
  dbSet(DB_KEYS.equipes, equipes);
  dbSet(DB_KEYS.chegada, []);
  renderChegada(); renderEquipes();
}
function tabelaDeEstat(nomes, totalLinhas){
  const linhas = [];
  nomes.forEach(n=>linhas.push({nome:n, amarelo:0, vermelho:0, gols:0}));
  while(linhas.length<totalLinhas){ linhas.push({nome:'', amarelo:0, vermelho:0, gols:0}); }
  return linhas;
}
function renderChegada(){
  const list = dbGet(DB_KEYS.chegada, []);
  const tbody = document.getElementById('tbodyChegada');
  tbody.innerHTML = list.map((n,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${n}</td>
      <td class="right"><button class="btn bad" onclick="removerChegada(${i})">Remover</button></td>
    </tr>`).join('');
  document.getElementById('kpiFila').textContent = list.length;
  const equipes = dbGet(DB_KEYS.equipes, []);
  document.getElementById('kpiEquipes').textContent = equipes.reduce((acc,e)=>acc+e.tabelas.length,0);
  document.getElementById('kpiRest').textContent = Math.max(list.length,0);
}
function renderEquipes(){
  const wrap = document.getElementById('equipesWrap');
  const equipes = dbGet(DB_KEYS.equipes, []);
  if(equipes.length===0){ wrap.innerHTML=''; return; }
  const blocos = equipes.map((bloco,bi)=>{
    const tabHtml = bloco.tabelas.map((t,ti)=>`
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th colspan="5">${t.nome}</th></tr>
            <tr><th>#</th><th>Nome</th><th>Cartão Amarelo</th><th>Cartão Vermelho</th><th>Gols</th></tr>
          </thead>
          <tbody>
            ${t.linhas.map((l,li)=>`
              <tr>
                <td>${li+1}</td>
                <td contenteditable="true" onblur="editaEquipe(${bi},${ti},${li},'nome',this.innerText)">${l.nome||''}</td>
                <td contenteditable="true" onblur="editaEquipe(${bi},${ti},${li},'amarelo',this.innerText)">${l.amarelo}</td>
                <td contenteditable="true" onblur="editaEquipe(${bi},${ti},${li},'vermelho',this.innerText)">${l.vermelho}</td>
                <td contenteditable="true" onblur="editaEquipe(${bi},${ti},${li},'gols',this.innerText)">${l.gols}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    `).join('');
    return `<div class="grid">
      <h4 style="margin-top:12px">${bloco.titulo}</h4>
      <div class="row-2">${tabHtml}</div>
    </div>`;
  }).join('');
  wrap.innerHTML = blocos;
}
function editaEquipe(bi,ti,li,campo,valor){
  const equipes = dbGet(DB_KEYS.equipes, []);
  const alvo = equipes[bi].tabelas[ti].linhas[li];
  if(['amarelo','vermelho','gols'].includes(campo)){
    valor = parseInt(valor)||0;
  } else {
    valor = String(valor||'');
  }
  alvo[campo]=valor;
  dbSet(DB_KEYS.equipes, equipes);
}

/* ============================================================
   Cadastro de Atletas
   ============================================================ */
function atualizaIdadeResp(){
  const nasc = document.getElementById('cadNasc').value;
  const idade = calcIdade(nasc);
  const resp = document.getElementById('cadResp');
  if(idade!=='' && idade<16){ resp.required = true; } else { resp.required=false; }
}

function buscaCEP(){
  const cep = onlyDigits(document.getElementById('cadCEP').value);
  if(cep.length!==8){ return; }
  // Tenta ViaCEP; se falhar, mantém campos editáveis
  fetch(`https://viacep.com.br/ws/${cep}/json/`)
    .then(r=>r.json()).then(d=>{
      if(d && !d.erro){
        document.getElementById('cadEndereco').value = `${d.logradouro || ''} ${d.bairro ? '- '+d.bairro : ''} ${d.localidade? '- '+d.localidade: ''} ${d.uf?'/'+d.uf:''}`.trim();
      }
    }).catch(()=>{/* ignore */});
}

function formReset(){
  document.getElementById('formAtleta').reset();
  document.getElementById('cadIdEditing').value='';
  document.getElementById('cadResp').required=false;
}

function salvarAtleta(e){
  e.preventDefault();
  const idEditing = document.getElementById('cadIdEditing').value;
  const nome = document.getElementById('cadNome').value.trim();
  const nasc = document.getElementById('cadNasc').value;
  const resp = document.getElementById('cadResp').value.trim();
  const cpf = onlyDigits(document.getElementById('cadCPF').value);
  const fone = onlyDigits(document.getElementById('cadFone').value);
  const cep = onlyDigits(document.getElementById('cadCEP').value);
  const endereco = document.getElementById('cadEndereco').value.trim();
  const compl = document.getElementById('cadCompl').value.trim();
  const num = document.getElementById('cadNum').value.trim();

  const letras = (nome.replace(/[^a-zA-ZÀ-ÿ]/g,'').length);
  if(letras<10){ alert('O nome deve ter no mínimo 10 letras.'); return; }
  if(!validaCPF(cpf)){ alert('CPF inválido.'); return; }
  if(fone.length!==11){ alert('Telefone deve ter 11 dígitos (XXXXXXXXXXX).'); return; }
  const idade = calcIdade(nasc);
  if(idade<16 && !resp){ alert('Responsável é obrigatório para menores de 16.'); return; }

  const atletas = dbGet(DB_KEYS.atletas, []);
  if(idEditing){
    const idx = atletas.findIndex(a=>String(a.id)===String(idEditing));
    if(idx>-1){
      atletas[idx] = {...atletas[idx],
        nome, nasc, idade, resp, cpf, fone, cep, endereco, compl, num
      };
    }
  } else {
    const id = randId3();
    atletas.push({ id, nome, nasc, idade, resp, cpf, fone, cep, endereco, compl, num, pago: 0 });
  }
  // Ordenar alfabeticamente por nome
  atletas.sort((a,b)=>slug(a.nome).localeCompare(slug(b.nome)));
  dbSet(DB_KEYS.atletas, atletas);
  formReset(); renderAtletas(); fillAtletasSelect();
}

function editarAtleta(id){
  const atletas = dbGet(DB_KEYS.atletas, []);
  const a = atletas.find(x=>String(x.id)===String(id));
  if(!a) return;
  document.getElementById('cadIdEditing').value=a.id;
  document.getElementById('cadNome').value=a.nome;
  document.getElementById('cadNasc').value=a.nasc;
  document.getElementById('cadResp').value=a.resp||'';
  document.getElementById('cadCPF').value=a.cpf;
  document.getElementById('cadFone').value=a.fone;
  document.getElementById('cadCEP').value=a.cep||'';
  document.getElementById('cadEndereco').value=a.endereco||'';
  document.getElementById('cadCompl').value=a.compl||'';
  document.getElementById('cadNum').value=a.num||'';
  atualizaIdadeResp();
  // Troca para a aba de cadastro
  document.querySelector('.tab.active').classList.remove('active');
  document.querySelector('#panel-'+document.querySelector('.panel.active').id.split('-')[1]).classList.remove('active');
  document.querySelector('.tab[data-tab="cadastro"]').classList.add('active');
  document.getElementById('panel-cadastro').classList.add('active');
}

function excluirAtleta(id){
  if(!confirm('Excluir este atleta?')) return;
  const atletas = dbGet(DB_KEYS.atletas, []).filter(a=>String(a.id)!==String(id));
  dbSet(DB_KEYS.atletas, atletas);
  renderAtletas(); fillAtletasSelect();
}

function renderAtletas(){
  const q = slug(document.getElementById('buscaAtleta').value);
  const atletas = dbGet(DB_KEYS.atletas, []);
  const filtrados = atletas.filter(a=>{
    if(!q) return true;
    const campos = [
      String(a.id),
      a.nome,
      String(a.idade),
      a.nasc,
      a.cpf
    ].map(slug).join(' ');
    return campos.includes(q);
  });
  const tbody = document.getElementById('tbodyAtletas');
  tbody.innerHTML = filtrados.map(a=>`
    <tr>
      <td>${a.id}</td>
      <td>${a.nome}</td>
      <td>${a.idade}</td>
      <td>${a.nasc || ''}</td>
      <td>${a.cpf}</td>
      <td>${a.fone}</td>
      <td>${[a.endereco,a.compl,a.num].filter(Boolean).join(', ')}</td>
      <td>${money(a.pago||0)}</td>
      <td class="right">
        <div class="actions">
          <button class="btn soft" onclick="editarAtleta(${a.id})">Editar</button>
          <button class="btn bad" onclick="excluirAtleta(${a.id})">Excluir</button>
        </div>
      </td>
    </tr>
  `).join('');
}

/* ============================================================
   Controle de Caixa
   ============================================================ */
function fillAtletasSelect(){
  const sel = document.getElementById('movAtleta');
  const atletas = dbGet(DB_KEYS.atletas, []);
  sel.innerHTML = `<option value="">-- Nenhum --</option>` + atletas.map(a=>`<option value="${a.id}">${a.nome} (ID ${a.id})</option>`).join('');
}
function limparMovForm(){
  document.getElementById('movTipo').value='entrada';
  document.getElementById('movValor').value='';
  document.getElementById('movDesc').value='';
  document.getElementById('movAtleta').value='';
}
function salvarMov(e){
  e.preventDefault();
  const tipo = document.getElementById('movTipo').value;
  let valor = parseFloat(document.getElementById('movValor').value);
  if(!(valor>=0)) return;
  const desc = document.getElementById('movDesc').value.trim();
  const atletaId = document.getElementById('movAtleta').value;
  const movimentos = dbGet(DB_KEYS.movimentos, []);
  const mov = { id: crypto.randomUUID(), ts: new Date().toISOString(), tipo, valor, desc, atletaId: atletaId||null };
  movimentos.unshift(mov);
  dbSet(DB_KEYS.movimentos, movimentos);

  // Se vinculado ao atleta, atualiza "valor pago" (entrada adiciona, saída subtrai)
  if(atletaId){
    const atletas = dbGet(DB_KEYS.atletas, []);
    const idx = atletas.findIndex(a=>String(a.id)===String(atletaId));
    if(idx>-1){
      const delta = tipo==='entrada' ? valor : -valor;
      atletas[idx].pago = Math.max(0, (Number(atletas[idx].pago)||0) + delta);
      dbSet(DB_KEYS.atletas, atletas);
    }
  }
  limparMovForm(); renderMov(); renderAtletas(); renderKpiCaixa();
}
function editarMov(id){
  const movimentos = dbGet(DB_KEYS.movimentos, []);
  const m = movimentos.find(x=>x.id===id);
  if(!m) return;
  const novoTipo = prompt('Tipo (entrada/saida):', m.tipo);
  if(novoTipo!==null && (novoTipo==='entrada'||novoTipo==='saida')){
    const novoValor = parseFloat(prompt('Valor (R$):', m.valor));
    if(!Number.isNaN(novoValor)){
      // Reverter efeito anterior se houve vínculo
      if(m.atletaId){
        const atletas = dbGet(DB_KEYS.atletas, []);
        const idx = atletas.findIndex(a=>String(a.id)===String(m.atletaId));
        if(idx>-1){
          const deltaOld = m.tipo==='entrada' ? -m.valor : m.valor;
          atletas[idx].pago = Math.max(0,(Number(atletas[idx].pago)||0) + deltaOld);
          dbSet(DB_KEYS.atletas, atletas);
        }
      }
      m.tipo = novoTipo; m.valor = novoValor;
      dbSet(DB_KEYS.movimentos, movimentos);
      // Aplicar novo efeito
      if(m.atletaId){
        const atletas = dbGet(DB_KEYS.atletas, []);
        const idx = atletas.findIndex(a=>String(a.id)===String(m.atletaId));
        if(idx>-1){
          const deltaNew = m.tipo==='entrada' ? m.valor : -m.valor;
          atletas[idx].pago = Math.max(0,(Number(atletas[idx].pago)||0) + deltaNew);
          dbSet(DB_KEYS.atletas, atletas);
        }
      }
      renderMov(); renderAtletas(); renderKpiCaixa();
    }
  }
}
function excluirMov(id){
  if(!confirm('Excluir este registro?')) return;
  const movimentos = dbGet(DB_KEYS.movimentos, []);
  const idx = movimentos.findIndex(m=>m.id===id);
  if(idx>-1){
    const m = movimentos[idx];
    // Reverter vínculo em "pago"
    if(m.atletaId){
      const atletas = dbGet(DB_KEYS.atletas, []);
      const ai = atletas.findIndex(a=>String(a.id)===String(m.atletaId));
      if(ai>-1){
        const delta = m.tipo==='entrada' ? -m.valor : m.valor;
        atletas[ai].pago = Math.max(0,(Number(atletas[ai].pago)||0) + delta);
        dbSet(DB_KEYS.atletas, atletas);
      }
    }
    movimentos.splice(idx,1);
    dbSet(DB_KEYS.movimentos, movimentos);
    renderMov(); renderAtletas(); renderKpiCaixa();
  }
}
function renderMov(){
  const movimentos = dbGet(DB_KEYS.movimentos, []);
  const atletas = dbGet(DB_KEYS.atletas, []);
  const nomePorId = Object.fromEntries(atletas.map(a=>[String(a.id), a.nome]));
  const tbody = document.getElementById('tbodyMov');
  tbody.innerHTML = movimentos.map(m=>{
    const d = new Date(m.ts);
    const when = d.toLocaleString('pt-BR');
    return `<tr>
      <td>${when}</td>
      <td>${m.tipo==='entrada' ? 'Entrada' : 'Saída'}</td>
      <td>${money(m.valor)}</td>
      <td>${m.desc||''}</td>
      <td>${m.atletaId? `${nomePorId[String(m.atletaId)]||'ID '+m.atletaId}` : '-'}</td>
      <td class="right">
        <div class="actions">
          <button class="btn soft" onclick="editarMov('${m.id}')">Editar</button>
          <button class="btn bad" onclick="excluirMov('${m.id}')">Excluir</button>
        </div>
      </td>
    </tr>`;
  }).join('');
  renderKpiCaixa();
}
function renderKpiCaixa(){
  const movimentos = dbGet(DB_KEYS.movimentos, []);
  const entradas = movimentos.filter(m=>m.tipo==='entrada').reduce((s,m)=>s+m.valor,0);
  const saidas = movimentos.filter(m=>m.tipo==='saida').reduce((s,m)=>s+m.valor,0);
  const total = entradas - saidas;
  document.getElementById('kpiCaixa').textContent = money(total);
  document.getElementById('kpiEntradas').textContent = money(entradas);
  document.getElementById('kpiSaidas').textContent = money(saidas);
}

/* ============================================================
   Campeonato
   ============================================================ */
function addCampeonatoJogador(e){
  e.preventDefault();
  const nome = document.getElementById('campNome').value.trim();
  const nasc = document.getElementById('campNasc').value;
  const idade = calcIdade(nasc);
  if(!nome){ return; }
  const camp = dbGet(DB_KEYS.campeonato, []);
  camp.push({ id: crypto.randomUUID(), nome, nasc, idade, vitorias:0, empates:0, derrotas:0, gols:0 });
  dbSet(DB_KEYS.campeonato, camp);
  document.getElementById('campNome').value='';
  document.getElementById('campNasc').value='';
  document.getElementById('campIdade').value='';
  renderCamp();
}
function campCalc(j){
  const jogos = (Number(j.vitorias)||0) + (Number(j.empates)||0) + (Number(j.derrotas)||0);
  const pontos = (Number(j.vitorias)||0)*3 + (Number(j.empates)||0);
  return { jogos, pontos };
}
function renderCamp(){
  const sortBy = document.getElementById('campSort').value;
  const camp = dbGet(DB_KEYS.campeonato, []);
  camp.forEach(j=>{ const c=campCalc(j); j._pontos=c.pontos; j._jogos=c.jogos; });
  camp.sort((a,b)=>{
    if(sortBy==='pontos') return b._pontos - a._pontos || a.nome.localeCompare(b.nome);
    if(sortBy==='jogos') return b._jogos - a._jogos || a.nome.localeCompare(b.nome);
    if(['vitorias','empates','derrotas','gols'].includes(sortBy)) return (Number(b[sortBy])||0) - (Number(a[sortBy])||0) || a.nome.localeCompare(b.nome);
    if(sortBy==='nome') return a.nome.localeCompare(b.nome);
    return 0;
  });
  const tbody = document.getElementById('tbodyCamp');
  tbody.innerHTML = camp.map((j,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${j.nome}</td>
      <td>${j._pontos}</td>
      <td>${j._jogos}</td>
      <td contenteditable="true" onblur="campEdit('${j.id}','vitorias',this.innerText)">${j.vitorias}</td>
      <td contenteditable="true" onblur="campEdit('${j.id}','empates',this.innerText)">${j.empates}</td>
      <td contenteditable="true" onblur="campEdit('${j.id}','derrotas',this.innerText)">${j.derrotas}</td>
      <td contenteditable="true" onblur="campEdit('${j.id}','gols',this.innerText)">${j.gols}</td>
      <td class="right">
        <div class="actions">
          <button class="btn soft" onclick="campEditPrompt('${j.id}')">Editar</button>
          <button class="btn bad" onclick="campExcluir('${j.id}')">Excluir</button>
        </div>
      </td>
    </tr>
  `).join('');
}
function campEdit(id, campo, valor){
  const camp = dbGet(DB_KEYS.campeonato, []);
  const j = camp.find(x=>x.id===id); if(!j) return;
  j[campo] = Math.max(0, parseInt(valor)||0);
  dbSet(DB_KEYS.campeonato, camp);
  renderCamp();
}
function campEditPrompt(id){
  const camp = dbGet(DB_KEYS.campeonato, []);
  const j = camp.find(x=>x.id===id); if(!j) return;
  const v = parseInt(prompt('Vitórias:', j.vitorias)); if(!Number.isNaN(v)) j.vitorias=Math.max(0,v);
  const e = parseInt(prompt('Empates:', j.empates)); if(!Number.isNaN(e)) j.empates=Math.max(0,e);
  const d = parseInt(prompt('Derrotas:', j.derrotas)); if(!Number.isNaN(d)) j.derrotas=Math.max(0,d);
  const g = parseInt(prompt('Gols:', j.gols)); if(!Number.isNaN(g)) j.gols=Math.max(0,g);
  dbSet(DB_KEYS.campeonato, camp);
  renderCamp();
}
function campExcluir(id){
  if(!confirm('Excluir este atleta do campeonato?')) return;
  const camp = dbGet(DB_KEYS.campeonato, []).filter(j=>j.id!==id);
  dbSet(DB_KEYS.campeonato, camp);
  renderCamp();
}

/* ============================================================
   Render inicial
   ============================================================ */
function renderAll(){
  renderChegada();
  renderEquipes();
  renderAtletas();
  fillAtletasSelect();
  renderMov();
  renderCamp();
}
renderAll(); // caso já esteja logado e recarregue (dev)
</script>
</body>
</html>

